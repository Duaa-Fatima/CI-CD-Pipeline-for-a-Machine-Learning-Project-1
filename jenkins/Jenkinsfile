pipeline {
   agent any
   
   stages {
       stage('Checkout') {
           steps {
               checkout([
                   $class: 'GitSCM',
                   branches: [[name: '*/dev']], // Ensure we are checking out the dev branch
                   userRemoteConfigs: [[url: 'https://github.com/Duaa-Fatima/CI-CD-Pipeline-for-a-Machine-Learning-Project-1']]
               ])
           }
       }
       
       stage('Build Docker Image') {
           steps {
               bat 'docker build -t wthduaa/diabetes-predictor:latest -f docker/Dockerfile .' 
           }
       }
       
       stage('Push to Docker Hub') {
           steps {
               withCredentials([usernamePassword(credentialsId: 'docker-hub-cred', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                   bat 'echo %DOCKER_PASSWORD%> temp.txt'
                   bat 'type temp.txt | docker login -u %DOCKER_USERNAME% --password-stdin'
                   bat 'del temp.txt'
                   
                   // Push the image
                   bat 'docker push wthduaa/diabetes-predictor:latest'
               }
           }
       }
       
       stage('Email Notification') {
           steps {
               script {
                   powershell '''
                   $smtpServer = "smtp.gmail.com"
                   $smtpPort = "587"
                   $emailFrom = "fatimaduaa053@gmail.com"
                   $emailTo = "fatimaduaa053@gmail.com"
                   $subject = "Jenkins Pipeline Success"
                   $body = "CI/CD Pipeline Completed Successfully!"
                   $username = "fatimaduaa053@gmail.com"
                   $password = "gjrt exav juqi roei"

                   $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
                   $credential = New-Object System.Management.Automation.PSCredential ($username, $securePassword)

                   Send-MailMessage -From $emailFrom -To $emailTo -Subject $subject -Body $body -SmtpServer $smtpServer -Port $smtpPort -UseSsl -Credential $credential
                   '''
               }
           }
       }
   }
}
